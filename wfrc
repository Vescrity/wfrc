#!/bin/bash


[ -n "$WAYLAND_DISPLAY" ] ||  exit 1

SCRIPT_NAME=wfrc
LOCK=/tmp/WFRCLOCK
if [ -f "$LOCK" ]; then
  rm "$LOCK"
  pkill "$SCRIPT_NAME"
fi
touch "$LOCK"
kill_wfrc() {
  kill -TERM $wf_recorder_pid
  rm $LOCK
  echo "file://$FILE_NAME" | wl-copy -t 'text/uri-list'
  notify-send --app-name=$SCRIPT_NAME 'Finished.' --icon=record
}

trap 'kill_wfrc $$' SIGINT SIGTERM 
output=$(slurp)
result=$?
if ! [ $result -eq 0 ]; then
  rm "$LOCK"
  notify-send --app-name=$SCRIPT_NAME 'Canceled.' --icon=record
  exit
fi

notify-send --app-name=$SCRIPT_NAME 'Rec.' --icon=record
AUDIO_DEV="$(LANG=C pactl list sources | grep 'Name.*output'|cut -d ' ' -f 2)"
FILE_NAME="/tmp/$SCRIPT_NAME-$(date -u +%Y-%m-%dT%H-%M-%S).mp4" 
wf-recorder -f $FILE_NAME -g "$output" --audio=$AUDIO_DEV &

wf_recorder_pid=$!

wait $wf_recorder_pid

